services:
  # Prometheus - Metrics storage
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --storage.tsdb.retention.time=15d
      - --web.console.libraries=/usr/share/prometheus/console_libraries
      - --web.console.templates=/usr/share/prometheus/consoles
      - --web.enable-lifecycle
      - --web.enable-remote-write-receiver
      - --web.enable-admin-api
    configs:
      - source: prometheus-config
        target: /etc/prometheus/prometheus.yml
        uid: "65534" # uid = nobody
        gid: "65534" # gid = nobody
        mode: 0400
    volumes:
      - prometheus-data:/prometheus
    networks:
      - services-network
      - monitoring-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.${BASE_DOMAIN}`)"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"
      - "traefik.http.routers.prometheus.middlewares=oidc-prometheus-dashboard@docker" # remove this if Zitadel is not present
      # Protect endpoint using OIDC middleware
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Secret=${TRAEFIK_OIDC_AUTH_SECRET}"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.CallbackUri=/oidc/callback"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.LogoutUri=/oidc/logout"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.SessionCookie.Domain=.${BASE_DOMAIN}"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Provider.Url=https://zitadel.${BASE_DOMAIN}"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Provider.ClientId=${PROMETHEUS_CLIENT_ID}"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Provider.UsePkce=true"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Scopes[0]=openid"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Scopes[1]=profile"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Scopes[2]=email"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[0].Name=X-Oidc-Username"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[0].Value={{ .claims.preferred_username }}"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[1].Name=X-Oidc-Subject"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[1].Value=sub"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[2].Name=X-Oidc-Roles"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[2].Value={{ .claims.roles }}"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[3].Name=Authorization"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[3].Value=Bearer {{ .accessToken }}"
  # Grafana Alloy - Collector with built-in cAdvisor
  alloy:
    image: grafana/alloy:latest
    container_name: alloy
    restart: unless-stopped
    privileged: true
    command:
      - run
      - /etc/alloy/config.alloy
      - --server.http.listen-addr=0.0.0.0:12345
      - --storage.path=/var/lib/alloy/data
    environment:
      - ALLOY_DEPLOY_MODE=docker
      - HOSTNAME=${HOSTNAME:-docker-vm}
    configs:
      - source: alloy-config
        target: /etc/alloy/config.alloy
    volumes:
      - /var/run:/var/run:rw
      - /:/rootfs:ro
      - /sys:/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
      - alloy-data:/var/lib/alloy
    networks:
      - monitoring-network
      - services-network
    ports:
      - "4318:4318"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.alloy.rule=Host(`alloy.${BASE_DOMAIN}`)"
      - "traefik.http.routers.alloy.entrypoints=websecure"
      - "traefik.http.services.alloy.loadbalancer.server.port=12345"
      - "traefik.http.routers.alloy.middlewares=oidc-alloy-dashboard@docker" # remove this if Zitadel is not present
      # Protect endpoint using OIDC middleware
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Secret=${TRAEFIK_OIDC_AUTH_SECRET}"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.CallbackUri=/oidc/callback"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.LogoutUri=/oidc/logout"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.SessionCookie.Domain=.${BASE_DOMAIN}"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Provider.Url=https://zitadel.${BASE_DOMAIN}"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Provider.ClientId=${ALLOY_CLIENT_ID}"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Provider.UsePkce=true"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Scopes[0]=openid"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Scopes[1]=profile"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Scopes[2]=email"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[0].Name=X-Oidc-Username"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[0].Value={{ .claims.preferred_username }}"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[1].Name=X-Oidc-Subject"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[1].Value=sub"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[2].Name=X-Oidc-Roles"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[2].Value={{ .claims.roles }}"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[3].Name=Authorization"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[3].Value=Bearer {{ .accessToken }}"
    devices:
      - /dev/kmsg
  # Loki - Log storage
  loki:
    image: grafana/loki:latest
    container_name: loki
    command: -config.file=/etc/loki/local-config.yaml
    configs:
      - source: loki-config
        target: /etc/loki/local-config.yaml
    volumes:
      - loki-data:/loki
    networks:
      - monitoring-network
    restart: unless-stopped
    ports:
      - "3100:3100"
configs:
  prometheus-config: # ./files/prometheus-config.yml
    content: |-
      global:
        scrape_interval: 15s
        evaluation_interval: 15s
        external_labels:
          cluster: 'docker-cluster'
          environment: 'production'

      scrape_configs:
        # Prometheus itself
        - job_name: 'prometheus'
          static_configs:
            - targets: ['localhost:9090']

        # Docker daemon metrics (exposed on host)
        - job_name: 'docker-daemon'
          static_configs:
            - targets: ['host.docker.internal:9323']
          relabel_configs:
            - source_labels: [__address__]
              target_label: instance
              replacement: 'docker-host'

        # Grafana Alloy self-monitoring
        - job_name: 'alloy'
          static_configs:
            - targets: ['alloy:12345']
  alloy-config: # ./files/alloy-config.alloy
    content: |-
      // ============================================================================
      // OPENTELEMETRY RECEIVER FOR PROXMOX
      // ============================================================================

      // Receive OpenTelemetry metrics from Proxmox via HTTP
      otelcol.receiver.otlp "proxmox" {
        http {
          endpoint = "0.0.0.0:4318"
        }

        output {
          metrics = [otelcol.processor.batch.proxmox.input]
        }
      }

      // Batch metrics for efficiency
      otelcol.processor.batch "proxmox" {
        output {
          metrics = [otelcol.exporter.prometheus.proxmox.input]
        }
      }

      // Convert OTLP metrics to Prometheus format
      otelcol.exporter.prometheus "proxmox" {
        forward_to = [prometheus.remote_write.local.receiver]
      }

      // ============================================================================
      // METRICS COLLECTION
      // ============================================================================

      // Built-in cAdvisor exporter for container metrics
      prometheus.exporter.cadvisor "containers" {
        docker_host      = "unix:///var/run/docker.sock"
        storage_duration = "5m"
      }

      // Host/VM system metrics (CPU, memory, disk, network)
      prometheus.exporter.unix "host" {
        // Exports node_* metrics for host-level monitoring
      }

      // Add relabeling to clean up labels
      prometheus.relabel "cadvisor_cleanup" {
        forward_to = [prometheus.remote_write.local.receiver]

        // Extract and rename useful compose labels
        rule {
          source_labels = ["container_label_com_docker_compose_service"]
          target_label  = "service"
        }

        rule {
          source_labels = ["container_label_com_docker_compose_project"]
          target_label  = "project"
        }

        rule {
          source_labels = ["container_label_com_docker_compose_image"]
          target_label  = "compose_image"
        }

        // Extract and rename image version
        rule {
          source_labels = ["container_label_org_opencontainers_image_version"]
          target_label  = "image_version"
        }

        // Drop ALL com_docker_compose labels (we already extracted what we need)
        rule {
          regex  = "container_label_com_docker_compose_.*"
          action = "labeldrop"
        }

        // Drop ALL traefik labels
        rule {
          regex  = "container_label_traefik_.*"
          action = "labeldrop"
        }

        // Drop ALL opencontainers labels (we already extracted what we need)
        rule {
          regex  = "container_label_org_opencontainers_.*"
          action = "labeldrop"
        }

        // Drop other common noisy labels
        rule {
          regex  = "container_label_com_centurylinklabs_.*"
          action = "labeldrop"
        }
      }

      // Scrape cAdvisor metrics and send through relabeling
      prometheus.scrape "cadvisor" {
        targets         = prometheus.exporter.cadvisor.containers.targets
        forward_to      = [prometheus.relabel.cadvisor_cleanup.receiver]
        scrape_interval = "15s"
      }

      // Scrape host/VM metrics
      prometheus.scrape "unix" {
        targets         = prometheus.exporter.unix.host.targets
        forward_to      = [prometheus.remote_write.local.receiver]
        scrape_interval = "15s"
      }

      // Self-monitoring: expose Alloy metrics
      prometheus.exporter.self "alloy" { }

      prometheus.scrape "alloy_self" {
        targets    = prometheus.exporter.self.alloy.targets
        forward_to = [prometheus.remote_write.local.receiver]
      }

      // Forward metrics to Prometheus
      prometheus.remote_write "local" {
        endpoint {
          url = "http://prometheus:9090/api/v1/write"

          queue_config {
            capacity             = 10000
            max_shards           = 10
            min_shards           = 1
            max_samples_per_send = 5000
            batch_send_deadline  = "5s"
          }
        }
      }

      // ============================================================================
      // LOG COLLECTION
      // ============================================================================

      // Discover all Docker containers
      discovery.docker "containers" {
        host = "unix:///var/run/docker.sock"
      }

      // Relabel to clean up container names
      discovery.relabel "containers" {
        targets = discovery.docker.containers.targets

        rule {
          source_labels = ["__meta_docker_container_name"]
          regex         = "/(.*)"
          target_label  = "container_name"
        }

        rule {
          source_labels = ["__meta_docker_container_label_com_docker_compose_project"]
          target_label  = "compose_project"
        }

        rule {
          source_labels = ["__meta_docker_container_label_com_docker_compose_service"]
          target_label  = "compose_service"
        }
      }

      // Scrape logs from discovered containers
      loki.source.docker "containers" {
        host       = "unix:///var/run/docker.sock"
        targets    = discovery.relabel.containers.output
        forward_to = [loki.process.add_labels.receiver]
      }

      // Add additional labels and process logs
      loki.process "add_labels" {
        // Add hostname label
        stage.static_labels {
          values = {
            hostname = env("HOSTNAME"),
            cluster  = "docker-cluster",
          }
        }

        // Parse JSON logs (if applicable)
        stage.json {
          expressions = {
            level = "level",
            msg   = "msg",
          }
        }

        // Extract log level from common patterns
        stage.regex {
          expression = "(?i)(?P<extracted_level>debug|info|warn|warning|error|fatal|critical)"
        }

        stage.labels {
          values = {
            level = "extracted_level",
          }
        }

        forward_to = [loki.write.local.receiver]
      }

      // Write logs to Loki
      loki.write "local" {
        endpoint {
          url = "http://loki:3100/loki/api/v1/push"

          batch_wait = "1s"
          batch_size = "1MiB"
        }

        external_labels = {
          cluster = "docker-cluster",
        }
      }
  loki-config: # ./files/loki-config.yml
    content: |-
      auth_enabled: false

      server:
        http_listen_port: 3100
        grpc_listen_port: 9096
        http_server_read_timeout: 120s
        http_server_write_timeout: 120s
        grpc_server_max_recv_msg_size: 33554432  # 32MB
        grpc_server_max_send_msg_size: 33554432  # 32MB

      common:
        instance_addr: 127.0.0.1
        path_prefix: /loki
        storage:
          filesystem:
            chunks_directory: /loki/chunks
            rules_directory: /loki/rules
        replication_factor: 1
        ring:
          kvstore:
            store: inmemory

      querier:
        max_concurrent: 4
        query_timeout: 60s

      query_scheduler:
        max_outstanding_requests_per_tenant: 256

      query_range:
        split_queries_by_interval: 30m
        parallelise_shardable_queries: false
        results_cache:
          cache:
            embedded_cache:
              enabled: true
              max_size_mb: 200

      schema_config:
        configs:
          - from: 2020-10-24
            store: tsdb
            object_store: filesystem
            schema: v13
            index:
              prefix: index_
              period: 24h

      ruler:
        alertmanager_url: http://localhost:9093

      limits_config:
        retention_period: 168h
        ingestion_rate_mb: 10
        ingestion_burst_size_mb: 20
        per_stream_rate_limit: 10MB
        per_stream_rate_limit_burst: 50MB
        max_query_length: 721h
        max_query_lookback: 721h
        max_entries_limit_per_query: 5000

      compactor:
        working_directory: /loki/compactor
        compaction_interval: 10m
        retention_enabled: true
        retention_delete_delay: 2h
        retention_delete_worker_count: 150
        delete_request_store: filesystem

      analytics:
        reporting_enabled: true
networks:
  services-network:
    external: true
  monitoring-network:
    external: true
volumes:
  prometheus-data:
    external: true
  alloy-data:
    external: true
  loki-data:
    external: true
