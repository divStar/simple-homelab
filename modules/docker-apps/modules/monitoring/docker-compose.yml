services:
  # Prometheus - Metrics storage
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --storage.tsdb.retention.time=15d
      - --web.console.libraries=/usr/share/prometheus/console_libraries
      - --web.console.templates=/usr/share/prometheus/consoles
      - --web.enable-lifecycle
      - --web.enable-remote-write-receiver
      - --web.enable-admin-api
    volumes:
      - prometheus-data:/prometheus
      - /mnt/data/monitoring/prometheus-config.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - services-network
    extra_hosts:
      - "docker-vm:192.168.178.120"
      - "proxmox:192.168.178.25"
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.${BASE_DOMAIN}`)"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"
      - "traefik.http.routers.prometheus.middlewares=oidc-prometheus-dashboard@docker" # remove this if Zitadel is not present
      # Protect endpoint using OIDC middleware
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Secret=${TRAEFIK_OIDC_AUTH_SECRET}"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.CallbackUri=/oidc/callback"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.LogoutUri=/oidc/logout"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.SessionCookie.Domain=.${BASE_DOMAIN}"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Provider.Url=https://zitadel.${BASE_DOMAIN}"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Provider.ClientId=${PROMETHEUS_CLIENT_ID}"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Provider.UsePkce=true"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Scopes[0]=openid"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Scopes[1]=profile"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Scopes[2]=email"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[0].Name=X-Oidc-Username"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[0].Value={{ .claims.preferred_username }}"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[1].Name=X-Oidc-Subject"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[1].Value=sub"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[2].Name=X-Oidc-Roles"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[2].Value={{ .claims.roles }}"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[3].Name=Authorization"
      - "traefik.http.middlewares.oidc-prometheus-dashboard.plugin.traefik-oidc-auth.Headers[3].Value=Bearer {{ .accessToken }}"
  # Grafana Alloy - Collector with built-in cAdvisor
  alloy:
    image: grafana/alloy:latest
    container_name: alloy
    restart: unless-stopped
    privileged: true
    command:
      - run
      - /etc/alloy/config.alloy
      - --server.http.listen-addr=0.0.0.0:12345
      - --storage.path=/var/lib/alloy/data
    environment:
      - ALLOY_DEPLOY_MODE=docker
      - HOSTNAME=${HOSTNAME:-docker-vm}
    volumes:
      - /var/run:/var/run:rw
      - /:/rootfs:ro
      - /sys:/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
      - alloy-data:/var/lib/alloy
      - /var/log/journal:/var/log/journal:ro
      - /mnt/data/monitoring/alloy-config.alloy:/etc/alloy/config.alloy:ro
    networks:
      - services-network
    ports:
      - "4318:4318"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.alloy.rule=Host(`alloy.${BASE_DOMAIN}`)"
      - "traefik.http.routers.alloy.entrypoints=websecure"
      - "traefik.http.services.alloy.loadbalancer.server.port=12345"
      - "traefik.http.routers.alloy.middlewares=oidc-alloy-dashboard@docker" # remove this if Zitadel is not present
      # Protect endpoint using OIDC middleware
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Secret=${TRAEFIK_OIDC_AUTH_SECRET}"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.CallbackUri=/oidc/callback"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.LogoutUri=/oidc/logout"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.SessionCookie.Domain=.${BASE_DOMAIN}"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Provider.Url=https://zitadel.${BASE_DOMAIN}"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Provider.ClientId=${ALLOY_CLIENT_ID}"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Provider.UsePkce=true"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Scopes[0]=openid"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Scopes[1]=profile"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Scopes[2]=email"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[0].Name=X-Oidc-Username"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[0].Value={{ .claims.preferred_username }}"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[1].Name=X-Oidc-Subject"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[1].Value=sub"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[2].Name=X-Oidc-Roles"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[2].Value={{ .claims.roles }}"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[3].Name=Authorization"
      - "traefik.http.middlewares.oidc-alloy-dashboard.plugin.traefik-oidc-auth.Headers[3].Value=Bearer {{ .accessToken }}"
    devices:
      - /dev/kmsg
  # Loki - Log storage
  loki:
    image: grafana/loki:latest
    container_name: loki
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki-data:/loki
      - /mnt/data/monitoring/loki-config.yml:/etc/loki/local-config.yaml:ro
    networks:
      - services-network
    restart: unless-stopped
    ports:
      - "3100:3100"
networks:
  services-network:
    external: true
volumes:
  prometheus-data:
    external: true
  alloy-data:
    external: true
  loki-data:
    external: true